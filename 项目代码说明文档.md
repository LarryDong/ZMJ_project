# 郑煤机项目说明文档

创建时间：2020/12/09，董岩

## 1. 目工程结构

ZMJ_project

- `lslidar`： 镭神激光雷达启动相关内容
  - `lidar_pkg`：自己所写的，启动两个激光雷达的 ros package
  - `command_lines.txt`: 记录激光雷达一些命令行
  - 其他文件：镭神出厂提供的文件，包括 msgs, driver, decorder等（有改动，官方提供的代码在ubuntu18下无法启动雷达，我在网络启动前增加了一行输出，便可以成功启动。原因不明）
- `slam`：定位与建图部分代码，主要来自于A-LOAM源码



## 2. 激光雷达配置

### 2.1 激光雷达相关ip说明

默认情况下，激光雷达发送的数据有：

- 数据包：由激光雷达发送给上位机，192.168.1.200.2368 -> 192.168.1.102.2368，1206字节
- 其他包：也是由雷达发送给上位机，192.168.1.200.2369 -> 192.168.1.102.2369，注意这个发送频率很低，会被数据包淹没。所以查看时需要多翻看消息，找到对应的发送。

激光雷达的ip、上位机的两个端口可以修改，而激光雷达的端口不可修改也不需要修改。修改时，需要使用镭神提供的上位机软件，输入默认(或修改后)的 data port / telemetry port (default: 2368/23269)后，点击"lidar"图标，选择型号启动激光雷达。此时如果可以看到雷达数据，说明 data port 是对的；之后在"LSC32"标签页的"Parameter"下面读取雷达的状态，可以修改ip、端口等。

所以，主机的ip需要设置为192.168.1.102，可以从ipv4网络中直接设置，或者通过路由器MAC绑定。建议使用前者，设置时，需要将网关设置为：255.255.255.0。注意每次修改网络配置后，可能需要将网口重新启动（禁用再启用），以保证配置生效。

**可能遇到的问题有**：

1. 能够读取到雷达数据，但无法设置新的参数：这是 telemetry port 设置错误。进行抓包查看雷达的2369端口发送的数据是本机哪个端口接收，便可以得知正确的 telemetry port 
2. 软件的端口是独占，所以每次配置完，建议关闭软件重新打开。

### 2. 抓包方法

- windows下使用wireshark软件
- ubuntu下使用 tcpdump指令：`sudo tcpdump -n -i xxx(网卡)`

### 3. 双雷达使用配置

1. 首先用上位机分别配置两个雷达的ip和输出端口，程序中分别配置为：192.168.1.200, 2368/2369 和 192.168.1.201, 2370/2371
2. 使用同一个launch文件，同时启动两个雷达的driver和decorder。启动方式参考了官方的 `lslidar_c32_double.launch` 文件，但这个文件变量名称设置有问题。变量名称设置部分参考了`lslidar_c32.launch`文件。
3. 注意修改两个雷达的：`device_ip / msop_port / difop_port` 三个参数

**（出错时）可能遇到的问题：**

1. ros中启动第二个雷达时，第一个雷达的数据断掉：端口冲突，没有修改正确端口；
2. 两个雷达数据串扰，一个雷达偶尔显示另一个雷达收到的数据：没有在同一个launch文件中启动两个雷达；



## 4. 我遇到的奇葩的问题与解决办法

1. 激光雷达启动时无法抓到数据包：镭神的代码有bug，在启动时增加了一行的输出；
2. 使用路由器时，主机无法收到数据：激光雷达的ip(192.168.1.201)超出了路由器的地址池范围(1-200)，修改路由器的地址池或雷达的ip；
3. 无法读取激光雷达数据，激光雷达外壳带电：稳压电源距离雷达太近；

